<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>API gateway in Spring boot</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">API gateway in Spring boot</h1>
</header>
<section data-field="subtitle" class="p-summary">
APIs are a common way of communication between applications. In the case of microservice architecture, there will be a number of services…
</section>
<section data-field="body" class="e-content">
<section name="74e5" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="eedd" id="eedd" class="graf graf--h3 graf--leading graf--title">API gateway in Spring boot</h3><figure name="c678" id="c678" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*Z2klHBSyqGBu8fL0" data-width="6000" data-height="4000" data-unsplash-photo-id="fBnoUeVsrTk" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*Z2klHBSyqGBu8fL0"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@gstravinsky?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@gstravinsky?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener" target="_blank">Gabriele Stravinskaite</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener" target="_blank">Unsplash</a></figcaption></figure><p name="c95a" id="c95a" class="graf graf--p graf--hasDropCapModel graf--hasDropCap graf-after--figure"><span class="graf-dropCap">A</span>PIs are a common way of communication between applications. In the case of microservice architecture, there will be a number of services and the client has to know the hostnames of all underlying applications to invoke them.</p><p name="16e8" id="16e8" class="graf graf--p graf-after--p">To simplify this communication, we prefer a component between client and server to manage all API requests called API Gateway. Additionally, we can have other features which include:</p><ul class="postList"><li name="cbb2" id="cbb2" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Security</strong> — Authentication, authorization</li><li name="065e" id="065e" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Routing</strong> — routing, request/response manipulation, circuit breaker</li><li name="755a" id="755a" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Observability</strong> — metric aggregation, logging, tracing</li></ul><p name="b86a" id="b86a" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">Architectural benefits of API Gateway:</strong></p><ul class="postList"><li name="0a7e" id="0a7e" class="graf graf--li graf-after--p">Reduced complexity</li><li name="db12" id="db12" class="graf graf--li graf-after--li">Centralized control of policies</li><li name="27fa" id="27fa" class="graf graf--li graf-after--li">Simplified troubleshooting</li></ul><p name="f711" id="f711" class="graf graf--p graf-after--li">There are many types of implementations available for API Gateway which include — Spring Cloud Gateway, Zuul API Gateway, APIGee, EAG (Enterprise API Gateway)</p><p name="0749" id="0749" class="graf graf--p graf-after--p graf--trailing">In this article, we will see how to implement the Spring Cloud API gateway, filter incoming requests, manipulate requests/responses, and handle authentication.</p></div></div></section><section name="c576" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="c9ee" id="c9ee" class="graf graf--p graf--leading">We can visualize the whole ecosystem as below:</p><figure name="5894" id="5894" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*oVoAGAvA7y_YWtbMHhNRFg.png" data-width="1430" data-height="946" src="https://cdn-images-1.medium.com/max/800/1*oVoAGAvA7y_YWtbMHhNRFg.png"><figcaption class="imageCaption">Dataflow</figcaption></figure><p name="dba4" id="dba4" class="graf graf--p graf-after--figure">In the above diagram, we have 5 services</p><ul class="postList"><li name="3324" id="3324" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Service Registry </strong>— The application that keeps track of the available instances of each microservice in a project.</li><li name="0b6a" id="0b6a" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">API Gateway</strong> — receives incoming requests, performs authentication (if enabled) and forwards requests to actual microservice. On getting the response, return it to the consumer.</li><li name="6e29" id="6e29" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Authentication server </strong>— The application that takes care of authentication</li><li name="6f17" id="6f17" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">First and Second Microservices</strong> — Two normal internal applications with different functionalities.</li></ul><p name="2f00" id="2f00" class="graf graf--p graf-after--li">All the applications on startup register themselves into <code class="markup--code markup--p-code">Service Registry</code>. Below are the steps that occur upon receiving any API request:</p><ol class="postList"><li name="1fe5" id="1fe5" class="graf graf--li graf-after--p">The consumer calls any application via the API gateway.</li><li name="7349" id="7349" class="graf graf--li graf-after--li">API gateway will check if the incoming URL needs authentication. If yes, it calls the Authentication server to validate it.</li><li name="e653" id="e653" class="graf graf--li graf-after--li">If it is a valid token, it forwards the requests to the corresponding application after applying filters.</li><li name="f160" id="f160" class="graf graf--li graf-after--li">If it is an invalid token, respond to the consumer as unauthorized.</li><li name="b946" id="b946" class="graf graf--li graf-after--li">Once it receives a response from an internal microservice, it returns it back to the consumer after applying filters.</li></ol><p name="a6e5" id="a6e5" class="graf graf--p graf-after--li">The filters in Gateway can include operations like logging or manipulating/customizing the request/response details.</p><blockquote name="5561" id="5561" class="graf graf--blockquote graf-after--p graf--trailing"><em class="markup--em markup--blockquote-em">Note: </em>Here, the individual services will be residing in the intranet and we will be exposing only the APIGateway service for consumers.</blockquote></div></div></section><section name="e04b" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="b086" id="b086" class="graf graf--p graf--leading"><strong class="markup--strong markup--p-strong">Service registry</strong></p><p name="403c" id="403c" class="graf graf--p graf-after--p">An application that serves as an Eureka server. This will have the below dependency in <code class="markup--code markup--p-code">pom.xml</code></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="ec71" id="ec71" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br />  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></pre><p name="bb62" id="bb62" class="graf graf--p graf-after--pre">And<code class="markup--code markup--p-code">@EnableEurekaServer</code> annotation in the main class.</p><p name="9bb0" id="9bb0" class="graf graf--p graf-after--p">By default, the Eureka server will register itself into discovery. We need to disable it by including the below properties in <code class="markup--code markup--p-code">application.properties</code></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="ini" name="52a4" id="52a4" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">eureka.client.registerWithEureka</span> = <span class="hljs-literal">false</span><br /><span class="hljs-attr">eureka.client.fetchRegistry</span> = <span class="hljs-literal">false</span></span></pre><p name="eef6" id="eef6" class="graf graf--p graf-after--pre">Make other applications as Eureka clients by including the below dependency in <code class="markup--code markup--p-code">pom.xml</code>:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="2d64" id="2d64" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br />  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></pre><p name="e337" id="e337" class="graf graf--p graf-after--pre">and, provide the Eureka server URL in <code class="markup--code markup--p-code">application.properties</code>:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="ini" name="6b3f" id="6b3f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">eureka.client.serviceUrl.defaultZone</span>= &lt;host-and-port-where-eureka-server-running&gt;</span></pre><p name="94d8" id="94d8" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">API Gateway:</strong></p><p name="3484" id="3484" class="graf graf--p graf-after--p">For the Spring Cloud API gateway, we need the below dependencies in <code class="markup--code markup--p-code">pom.xml</code></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="ebc7" id="ebc7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br />  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br />  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br /><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br /> <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br />  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br />   <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br />   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br />  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br /> <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span></span></pre><p name="2994" id="2994" class="graf graf--p graf-after--pre">In <code class="markup--code markup--p-code">application.yml</code> file, provide details of all internal microservice names, paths, and uri as below:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="yaml" name="a872" id="a872" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">spring:</span><br />  <span class="hljs-attr">application:</span><br />    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway-service</span><br />  <span class="hljs-attr">cloud:</span><br />    <span class="hljs-attr">gateway:</span><br />      <span class="hljs-attr">routes:</span><br />        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">first</span><br />          <span class="hljs-attr">predicates:</span><br />            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/first/</span><br />          <span class="hljs-attr">uri:</span> <span class="hljs-string">localhost:8081</span><br />        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">second</span><br />          <span class="hljs-attr">predicates:</span><br />            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/second/</span><br />          <span class="hljs-attr">uri:</span> <span class="hljs-string">localhost:8082</span><br />        <span class="hljs-bullet">-</span> <span class="hljs-attr">id :</span> <span class="hljs-string">auth-server</span><br />          <span class="hljs-attr">predicates:</span><br />            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/login/</span><br />          <span class="hljs-attr">uri:</span> <span class="hljs-string">localhost:8088</span></span></pre><p name="6cc0" id="6cc0" class="graf graf--p graf-after--pre">And we need to have a bean of <code class="markup--code markup--p-code">RouteLocator</code> type to provide all the routes the Gateway serves. We can include any filter if we want to process the request/response:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="less" name="c5de" id="c5de" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-variable">@Bean</span><br />    public RouteLocator <span class="hljs-built_in">customRouteLocator</span>(RouteLocatorBuilder builder) {<br />                <span class="hljs-comment">// adding 2 rotes to first microservice as we need to log request body if method is POST</span><br />        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">builder</span><span class="hljs-selector-class">.routes</span>()<br />                <span class="hljs-selector-class">.route</span>(<span class="hljs-string">&quot;first-microservice&quot;</span>,r -&gt; r.<span class="hljs-built_in">path</span>(<span class="hljs-string">&quot;/first&quot;</span>)<br />                        .<span class="hljs-built_in">and</span>().<span class="hljs-built_in">method</span>(<span class="hljs-string">&quot;POST&quot;</span>)<br />                        .<span class="hljs-built_in">and</span>().<span class="hljs-built_in">readBody</span>(Student.class, s -&gt; true).<span class="hljs-built_in">filters</span>(f -&gt; f.<span class="hljs-built_in">filters</span>(requestFilter, authFilter))<br />                        .<span class="hljs-built_in">uri</span>(<span class="hljs-string">&quot;http://localhost:8081&quot;</span>))<br />                <span class="hljs-selector-class">.route</span>(<span class="hljs-string">&quot;first-microservice&quot;</span>,r -&gt; r.<span class="hljs-built_in">path</span>(<span class="hljs-string">&quot;/first&quot;</span>)<br />                        .<span class="hljs-built_in">and</span>().<span class="hljs-built_in">method</span>(<span class="hljs-string">&quot;GET&quot;</span>).<span class="hljs-built_in">filters</span>(f-&gt; f.<span class="hljs-built_in">filters</span>(authFilter))<br />                        .<span class="hljs-built_in">uri</span>(<span class="hljs-string">&quot;http://localhost:8081&quot;</span>))<br />                <span class="hljs-selector-class">.route</span>(<span class="hljs-string">&quot;second-microservice&quot;</span>,r -&gt; r.<span class="hljs-built_in">path</span>(<span class="hljs-string">&quot;/second&quot;</span>)<br />                        .<span class="hljs-built_in">and</span>().<span class="hljs-built_in">method</span>(<span class="hljs-string">&quot;POST&quot;</span>)<br />                        .<span class="hljs-built_in">and</span>().<span class="hljs-built_in">readBody</span>(Company.class, s -&gt; true).<span class="hljs-built_in">filters</span>(f -&gt; f.<span class="hljs-built_in">filters</span>(requestFilter, authFilter))<br />                        .<span class="hljs-built_in">uri</span>(<span class="hljs-string">&quot;http://localhost:8082&quot;</span>))<br />                <span class="hljs-selector-class">.route</span>(<span class="hljs-string">&quot;second-microservice&quot;</span>,r -&gt; r.<span class="hljs-built_in">path</span>(<span class="hljs-string">&quot;/second&quot;</span>)<br />                        .<span class="hljs-built_in">and</span>().<span class="hljs-built_in">method</span>(<span class="hljs-string">&quot;GET&quot;</span>).<span class="hljs-built_in">filters</span>(f-&gt; f.<span class="hljs-built_in">filters</span>(authFilter))<br />                        .<span class="hljs-built_in">uri</span>(<span class="hljs-string">&quot;http://localhost:8082&quot;</span>))<br />                <span class="hljs-selector-class">.route</span>(<span class="hljs-string">&quot;auth-server&quot;</span>,r -&gt; r.<span class="hljs-built_in">path</span>(<span class="hljs-string">&quot;/login&quot;</span>)<br />                        .<span class="hljs-built_in">uri</span>(<span class="hljs-string">&quot;http://localhost:8088&quot;</span>))<br />                <span class="hljs-selector-class">.build</span>();<br />    }</span></pre><p name="8534" id="8534" class="graf graf--p graf-after--pre">Filters:</p><p name="b076" id="b076" class="graf graf--p graf-after--p">A. <em class="markup--em markup--p-em">To log request body:</em></p><p name="9d87" id="9d87" class="graf graf--p graf-after--p">To read the body, in ResourceLocator bean we need to make readBody() as <code class="markup--code markup--p-code">true</code>. This makes, the ServerWebExchange object cache the request body in attribute — “cachedRequestBodyObject”.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="kotlin" name="0540" id="0540" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.filter;<br /><br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.model.Company;<br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.model.Student;<br /><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;<br /><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br /><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br /><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br /><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br /><br /><span class="hljs-meta">@Component</span><br /><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestFilter</span> <span class="hljs-title">implements</span> <span class="hljs-title">GatewayFilter</span> {<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">public</span> Mono&lt;<span class="hljs-built_in">Void</span>&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {<br />        Object body = exchange.getAttribute(<span class="hljs-string">&quot;cachedRequestBodyObject&quot;</span>);<br />        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;in request filter&quot;</span>);<br />        <span class="hljs-keyword">if</span>(body instanceof Student) {<br />            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;body:&quot;</span> + (Student) body);<br />        }<br />        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(body instanceof Company) {<br />            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;body:&quot;</span> + (Company) body);<br />        }<br />        <span class="hljs-keyword">return</span> chain.filter(exchange);<br />    }<br />}</span></pre><p name="b474" id="b474" class="graf graf--p graf-after--pre">B. <em class="markup--em markup--p-em">To log response body:</em></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="java" name="99da" id="99da" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.filter;<br /><br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.model.Company;<br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.model.Student;<br /><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;<br /><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br /><span class="hljs-keyword">import</span> org.reactivestreams.Publisher;<br /><span class="hljs-keyword">import</span> org.springframework.core.io.buffer.DataBuffer;<br /><span class="hljs-keyword">import</span> org.springframework.core.io.buffer.DataBufferFactory;<br /><span class="hljs-keyword">import</span> org.springframework.core.io.buffer.DefaultDataBuffer;<br /><span class="hljs-keyword">import</span> org.springframework.core.io.buffer.DefaultDataBufferFactory;<br /><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;<br /><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;<br /><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponseDecorator;<br /><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br /><span class="hljs-keyword">import</span> org.springframework.web.server.WebFilter;<br /><span class="hljs-keyword">import</span> org.springframework.web.server.WebFilterChain;<br /><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br /><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br /><br /><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br /><span class="hljs-keyword">import</span> java.util.List;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebFilter</span> {<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, WebFilterChain chain)</span> {<br />        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> exchange.getRequest().getPath().toString();<br />        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br />        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br />        <span class="hljs-type">DataBufferFactory</span> <span class="hljs-variable">dataBufferFactory</span> <span class="hljs-operator">=</span> response.bufferFactory();<br />        <span class="hljs-type">ServerHttpResponseDecorator</span> <span class="hljs-variable">decoratedResponse</span> <span class="hljs-operator">=</span> getDecoratedResponse(path, response, request, dataBufferFactory);<br />        <span class="hljs-keyword">return</span> chain.filter(exchange.mutate().response(decoratedResponse).build());<br />    }<br /><br />    <span class="hljs-keyword">private</span> ServerHttpResponseDecorator <span class="hljs-title function_">getDecoratedResponse</span><span class="hljs-params">(String path, ServerHttpResponse response, ServerHttpRequest request, DataBufferFactory dataBufferFactory)</span> {<br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerHttpResponseDecorator</span>(response) {<br /><br />            <span class="hljs-meta">@Override</span><br />            <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">writeWith</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Publisher&lt;? extends DataBuffer&gt; body)</span> {<br /><br />                <span class="hljs-keyword">if</span> (body <span class="hljs-keyword">instanceof</span> Flux) {<br /><br />                    Flux&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataBuffer</span>&gt; fluxBody = (Flux&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataBuffer</span>&gt;) body;<br /><br />                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.writeWith(fluxBody.buffer().map(dataBuffers -&gt; {<br /><br />                        <span class="hljs-type">DefaultDataBuffer</span> <span class="hljs-variable">joinedBuffers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultDataBufferFactory</span>().join(dataBuffers);<br />                        <span class="hljs-type">byte</span>[] content = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[joinedBuffers.readableByteCount()];<br />                        joinedBuffers.read(content);<br />                        <span class="hljs-type">String</span> <span class="hljs-variable">responseBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(content, StandardCharsets.UTF_8);<span class="hljs-comment">//MODIFY RESPONSE and Return the Modified response</span><br />                        System.out.println(<span class="hljs-string">&quot;requestId: &quot;</span>+request.getId()+<span class="hljs-string">&quot;, method: &quot;</span>+request.getMethodValue()+<span class="hljs-string">&quot;, req url: &quot;</span>+request.getURI()+<span class="hljs-string">&quot;, response body :&quot;</span>+ responseBody);<br />                        <span class="hljs-keyword">try</span> {<br />                            <span class="hljs-keyword">if</span>(request.getURI().getPath().equals(<span class="hljs-string">&quot;/first&quot;</span>) &amp;&amp; request.getMethodValue().equals(<span class="hljs-string">&quot;GET&quot;</span>)) {<br />                                List&lt;Student&gt; student = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(responseBody, List.class);<br />                                System.out.println(<span class="hljs-string">&quot;student:&quot;</span> + student);<br />                            }<br />                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(request.getURI().getPath().equals(<span class="hljs-string">&quot;/second&quot;</span>) &amp;&amp; request.getMethodValue().equals(<span class="hljs-string">&quot;GET&quot;</span>)) {<br />                                List&lt;Company&gt; companies = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(responseBody, List.class);<br />                                System.out.println(<span class="hljs-string">&quot;companies:&quot;</span> + companies);<br />                            }<br />                        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {<br />                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br />                        }<br />                        <span class="hljs-keyword">return</span> dataBufferFactory.wrap(responseBody.getBytes());<br />                    })).onErrorResume(err -&gt; {<br /><br />                        System.out.println(<span class="hljs-string">&quot;error while decorating Response: {}&quot;</span>+err.getMessage());<br />                        <span class="hljs-keyword">return</span> Mono.empty();<br />                    });<br /><br />                }<br />                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.writeWith(body);<br />            }<br />        };<br />    }<br /><br />}</span></pre><p name="3ca6" id="3ca6" class="graf graf--p graf-after--pre"><em class="markup--em markup--p-em">C. To authenticate before API invocations:</em></p><p name="fce2" id="fce2" class="graf graf--p graf-after--p">Create authentication filter as below:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="37a3" id="37a3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.filter;<br /><br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.util.AuthUtil;<br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.util.JWTUtil;<br /><span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.validator.RouteValidator;<br /><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;<br /><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br /><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br /><span class="hljs-keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;<br /><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;<br /><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br /><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br /><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;<br /><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;<br /><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br /><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br /><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br /><br /><span class="hljs-meta">@Component</span><br /><span class="hljs-meta">@RefreshScope</span><br /><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilter</span> {<br /><br />    <span class="hljs-meta">@Autowired</span><br />    RouteValidator routeValidator;<br /><br />    <span class="hljs-meta">@Autowired</span><br />    <span class="hljs-keyword">private</span> JWTUtil jwtUtil;<br /><br />    <span class="hljs-meta">@Autowired</span><br />    <span class="hljs-keyword">private</span> AuthUtil authUtil;<br /><br />    <span class="hljs-meta">@Value(&quot;${authentication.enabled}&quot;)</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> authEnabled;<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {<br />        <span class="hljs-keyword">if</span>(!authEnabled) {<br />            System.out.println(<span class="hljs-string">&quot;Authentication is disabled. To enable it, make \&quot;authentication.enabled\&quot; property as true&quot;</span>);<br />            <span class="hljs-keyword">return</span> chain.filter(exchange);<br />        }<br />        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&quot;</span>;<br />        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br /><br />        <span class="hljs-keyword">if</span>(routeValidator.isSecured.test(request)) {<br />            System.out.println(<span class="hljs-string">&quot;validating authentication token&quot;</span>);<br />            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.isCredsMissing(request)) {<br />                System.out.println(<span class="hljs-string">&quot;in error&quot;</span>);<br />                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.onError(exchange,<span class="hljs-string">&quot;Credentials missing&quot;</span>,HttpStatus.UNAUTHORIZED);<br />            }<br />            <span class="hljs-keyword">if</span> (request.getHeaders().containsKey(<span class="hljs-string">&quot;userName&quot;</span>) &amp;&amp; request.getHeaders().containsKey(<span class="hljs-string">&quot;role&quot;</span>)) {<br />                token = authUtil.getToken(request.getHeaders().get(<span class="hljs-string">&quot;userName&quot;</span>).toString(), request.getHeaders().get(<span class="hljs-string">&quot;role&quot;</span>).toString());<br />            }<br />            <span class="hljs-keyword">else</span> {<br />                token = request.getHeaders().get(<span class="hljs-string">&quot;Authorization&quot;</span>).toString().split(<span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">1</span>];<br />            }<br /><br />            <span class="hljs-keyword">if</span>(jwtUtil.isInvalid(token)) {<br />                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.onError(exchange,<span class="hljs-string">&quot;Auth header invalid&quot;</span>,HttpStatus.UNAUTHORIZED);<br />            }<br />            <span class="hljs-keyword">else</span> {<br />                System.out.println(<span class="hljs-string">&quot;Authentication is successful&quot;</span>);<br />            }<br /><br />            <span class="hljs-built_in">this</span>.populateRequestWithHeaders(exchange,token);<br />        }<br />        <span class="hljs-keyword">return</span> chain.filter(exchange);<br />    }<br /><br />    <span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title function_">onError</span><span class="hljs-params">(ServerWebExchange exchange, String err, HttpStatus httpStatus)</span> {<br />        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br />        response.setStatusCode(httpStatus);<br />        <span class="hljs-keyword">return</span> response.setComplete();<br />    }<br /><br />    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getAuthHeader</span><span class="hljs-params">(ServerHttpRequest request)</span> {<br />        <span class="hljs-keyword">return</span>  request.getHeaders().getOrEmpty(<span class="hljs-string">&quot;Authorization&quot;</span>).get(<span class="hljs-number">0</span>);<br />    }<br /><br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredsMissing</span><span class="hljs-params">(ServerHttpRequest request)</span> {<br />        <span class="hljs-keyword">return</span> !(request.getHeaders().containsKey(<span class="hljs-string">&quot;userName&quot;</span>) &amp;&amp; request.getHeaders().containsKey(<span class="hljs-string">&quot;role&quot;</span>)) &amp;&amp; !request.getHeaders().containsKey(<span class="hljs-string">&quot;Authorization&quot;</span>);<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateRequestWithHeaders</span><span class="hljs-params">(ServerWebExchange exchange, String token)</span> {<br />        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> jwtUtil.getALlClaims(token);<br />        exchange.getRequest()<br />                .mutate()<br />                .header(<span class="hljs-string">&quot;id&quot;</span>,String.valueOf(claims.get(<span class="hljs-string">&quot;id&quot;</span>)))<br />                .header(<span class="hljs-string">&quot;role&quot;</span>, String.valueOf(claims.get(<span class="hljs-string">&quot;role&quot;</span>)))<br />                .build();<br />    }<br />}</span></pre><p name="e7e6" id="e7e6" class="graf graf--p graf-after--pre">Some endpoints need to be unprotected i.e., to allow invocation without a token (e.g.: login URL, health check URL, etc.). We will add them to the below list :</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="java" name="3619" id="3619" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.validator;<br /><br /><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;<br /><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br /><br /><span class="hljs-keyword">import</span> java.util.List;<br /><span class="hljs-keyword">import</span> java.util.function.Predicate;<br /><br /><span class="hljs-meta">@Component</span><br /><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteValidator</span> {<br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; unprotectedURLs = List.of(<span class="hljs-string">&quot;/login&quot;</span>);<br /><br />    <span class="hljs-keyword">public</span> Predicate&lt;ServerHttpRequest&gt; isSecured = request -&gt; unprotectedURLs.stream().noneMatch(uri -&gt; request.getURI().getPath().contains(uri));<br />}</span></pre><p name="0814" id="0814" class="graf graf--p graf-after--pre">JWTUtil:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="typescript" name="e312" id="e312" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">package com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">util</span>;<br /><br /><span class="hljs-keyword">import</span> io.<span class="hljs-property">jsonwebtoken</span>.<span class="hljs-property">Claims</span>;<br /><span class="hljs-keyword">import</span> io.<span class="hljs-property">jsonwebtoken</span>.<span class="hljs-property">Jwts</span>;<br /><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;<br /><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;<br /><br /><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Date</span>;<br /><br /><span class="hljs-meta">@Component</span><br /><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JWTUtil</span> {<br /><br />    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;${jwt.secret}&quot;</span>)<br />    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> secret;<br /><br />    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Claims</span> <span class="hljs-title function_">getALlClaims</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token</span>) {<br />        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Jwts</span>.<span class="hljs-title function_">parserBuilder</span>().<span class="hljs-title function_">setSigningKey</span>(secret).<span class="hljs-title function_">build</span>().<span class="hljs-title function_">parseClaimsJws</span>(token).<span class="hljs-title function_">getBody</span>();<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isTokenExpired</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token </span>) {<br />        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getALlClaims</span>(token).<span class="hljs-title function_">getExpiration</span>().<span class="hljs-title function_">before</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br />    }<br /><br />    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isInvalid</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token</span>) {<br />        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isTokenExpired</span>(token);<br />    }<br /><br />}</span></pre><p name="94f4" id="94f4" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Authentication server:</strong></p><p name="936f" id="936f" class="graf graf--p graf-after--p">This service will provide you with the token for access to internal microservices.</p><blockquote name="3cd2" id="3cd2" class="graf graf--blockquote graf-after--p graf--trailing">Note: Authentication in itself is a huge topic. To make our example simpler, I have included a simple endpoint to return token. For more details on JWT authentication you can refer the article <a href="https://medium.com/@ankithahjpgowda/jwt-authentication-and-role-based-authorization-in-springboot-5aa13d7f35ce" data-href="https://medium.com/@ankithahjpgowda/jwt-authentication-and-role-based-authorization-in-springboot-5aa13d7f35ce" class="markup--anchor markup--blockquote-anchor" target="_blank"><strong class="markup--strong markup--blockquote-strong">JWT authentication and role-based authorization in Springboot</strong></a><strong class="markup--strong markup--blockquote-strong"> </strong>and the code <a href="https://github.com/oldfr/jwt-authentication-overview" data-href="https://github.com/oldfr/jwt-authentication-overview" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">here</a>.</blockquote></div></div></section><section name="3f98" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="019a" id="019a" class="graf graf--p graf--leading"><strong class="markup--strong markup--p-strong">Execution:</strong></p><p name="c606" id="c606" class="graf graf--p graf-after--p">Once all applications are running we can invoke the service registry using <code class="markup--code markup--p-code"><a href="http://localhost:8761" data-href="http://localhost:8761" class="markup--anchor markup--p-anchor" target="_blank">http://localhost:8761</a></code> from browser. It will have all the details about currently running services:</p><figure name="05f0" id="05f0" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*TkBkdvLj3CIdgZstnX_q4g.png" data-width="1714" data-height="1016" src="https://cdn-images-1.medium.com/max/800/1*TkBkdvLj3CIdgZstnX_q4g.png"></figure><p name="852b" id="852b" class="graf graf--p graf-after--figure">As the API Gateway is running on localhost at port 8080, you can invoke the endpoints of the First or Second microservice from <code class="markup--code markup--p-code">http://localhost:8080</code></p><figure name="1d0b" id="1d0b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*EpUt3AlJsp6HcP9ZgdsB8w.png" data-width="1422" data-height="701" src="https://cdn-images-1.medium.com/max/800/1*EpUt3AlJsp6HcP9ZgdsB8w.png"></figure><p name="1f24" id="1f24" class="graf graf--p graf-after--figure">Request/Response logs in the APIGateway console:</p><figure name="a368" id="a368" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*-ztV03zIi7T2pfn0CZukBA.png" data-width="1642" data-height="70" src="https://cdn-images-1.medium.com/max/800/1*-ztV03zIi7T2pfn0CZukBA.png"></figure><blockquote name="4d1c" id="4d1c" class="graf graf--blockquote graf-after--figure">Note: In this example, I have disabled authentication from API Gateway application. You can enable it from application.properties. If you enable it, provide “userName” and “role” in the request header.</blockquote><p name="15a7" id="15a7" class="graf graf--p graf-after--blockquote">Sample request with authentication:</p><figure name="04e2" id="04e2" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*m9gI2FHGoDd_ftHWuWie2A.png" data-width="1422" data-height="701" src="https://cdn-images-1.medium.com/max/800/1*m9gI2FHGoDd_ftHWuWie2A.png"></figure><p name="1db1" id="1db1" class="graf graf--p graf-after--figure">The completed codebase of all the services is available <a href="https://github.com/stars/oldfr/lists/api-gateway" data-href="https://github.com/stars/oldfr/lists/api-gateway" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here</a>.</p><p name="52d7" id="52d7" class="graf graf--p graf-after--p graf--trailing">Thank you for reading. Happy exploring!!!</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@ankithahjpgowda" class="p-author h-card">Ankitha Gowda</a> on <a href="https://medium.com/p/3ea804003021"><time class="dt-published" datetime="2023-10-07T16:50:05.785Z">October 7, 2023</time></a>.</p><p><a href="https://medium.com/@ankithahjpgowda/api-gateway-in-spring-boot-3ea804003021" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 9, 2025.</p></footer></article></body></html>